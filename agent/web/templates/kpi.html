{% extends "base.html" %}

{% block title %}KPI ダッシュボード - {{ super() }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">
                <i class="fas fa-dashboard me-2 text-primary"></i>
                KPI ダッシュボード
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">ダッシュボード</a></li>
                    <li class="breadcrumb-item active">KPI</li>
                </ol>
            </nav>
        </div>
    </div>
</div>

<!-- Period Selector -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="card-title mb-1">
                            <i class="fas fa-calendar-alt me-2"></i>
                            表示期間
                        </h5>
                        <p class="card-text text-muted mb-0">
                            KPI データの表示期間を選択してください。
                        </p>
                    </div>
                    <div class="col-md-4">
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="period" id="period7" value="7" checked>
                            <label class="btn btn-outline-primary" for="period7">7日</label>
                            
                            <input type="radio" class="btn-check" name="period" id="period30" value="30">
                            <label class="btn btn-outline-primary" for="period30">30日</label>
                            
                            <input type="radio" class="btn-check" name="period" id="period90" value="90">
                            <label class="btn btn-outline-primary" for="period90">90日</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KPI Summary Cards -->
<div class="row mb-4" id="kpiSummary">
    <!-- Will be populated dynamically -->
</div>

<!-- KPI Charts -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    実行時間推移
                </h5>
            </div>
            <div class="card-body">
                <canvas id="runtimeChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-yen-sign me-2"></i>
                    手数料推移
                </h5>
            </div>
            <div class="card-body">
                <canvas id="feeChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    総合KPI推移
                </h5>
            </div>
            <div class="card-body">
                <canvas id="combinedChart" width="600" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    異常検知
                </h5>
            </div>
            <div class="card-body" id="anomalyDetection">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Detailed KPI Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>
                        実行履歴
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="refreshKPI()">
                            <i class="fas fa-sync-alt me-1"></i>更新
                        </button>
                        <button class="btn btn-outline-success" onclick="exportKPI()">
                            <i class="fas fa-download me-1"></i>エクスポート
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="kpiTable">
                        <thead class="table-light">
                            <tr>
                                <th>実行日時</th>
                                <th class="text-end">実行時間 (秒)</th>
                                <th class="text-end">総手数料 (円)</th>
                                <th class="text-end">残高不足</th>
                                <th>状態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="kpiTableBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Metrics -->
<div class="row">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    パフォーマンス指標
                </h5>
            </div>
            <div class="card-body" id="performanceMetrics">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    品質指標
                </h5>
            </div>
            <div class="card-body" id="qualityMetrics">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" 
     id="loadingOverlay" style="background: rgba(0,0,0,0.5); z-index: 1050; display: none !important;">
    <div class="card border-0 shadow">
        <div class="card-body text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5>KPI データ読み込み中...</h5>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let kpiData = [];
let charts = {};

document.addEventListener('DOMContentLoaded', function() {
    // Setup period selector
    document.querySelectorAll('input[name="period"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                loadKPIData(parseInt(this.value));
            }
        });
    });
    
    // Load initial data
    loadKPIData(7);
});

function loadKPIData(days) {
    showLoading(true);
    
    fetch(`/api/kpi?days=${days}`)
        .then(response => response.json())
        .then(data => {
            if (data.kpi_history) {
                kpiData = data.kpi_history;
                displayKPIData();
            } else {
                // Generate mock data for demonstration
                kpiData = generateMockKPIData(days);
                displayKPIData();
            }
            showLoading(false);
        })
        .catch(error => {
            console.error('Error loading KPI data:', error);
            // Generate mock data as fallback
            kpiData = generateMockKPIData(days);
            displayKPIData();
            showLoading(false);
        });
}

function generateMockKPIData(days) {
    const data = [];
    const now = new Date();
    
    for (let i = days - 1; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(date.getDate() - i);
        
        // Skip some days to simulate realistic usage
        if (Math.random() > 0.7) continue;
        
        data.push({
            timestamp: date.toISOString(),
            total_fee: Math.floor(Math.random() * 5000) + 1000,
            total_shortfall: Math.random() > 0.9 ? Math.floor(Math.random() * 100000) : 0,
            runtime_sec: Math.random() * 10 + 0.5
        });
    }
    
    return data;
}

function displayKPIData() {
    updateKPISummary();
    updateKPICharts();
    updateKPITable();
    updatePerformanceMetrics();
    updateQualityMetrics();
    updateAnomalyDetection();
}

function updateKPISummary() {
    const container = document.getElementById('kpiSummary');
    
    if (kpiData.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    選択された期間にKPIデータがありません。
                </div>
            </div>
        `;
        return;
    }
    
    // Calculate summary statistics
    const totalRuns = kpiData.length;
    const avgRuntime = kpiData.reduce((sum, item) => sum + item.runtime_sec, 0) / totalRuns;
    const avgFee = kpiData.reduce((sum, item) => sum + item.total_fee, 0) / totalRuns;
    const totalShortfall = kpiData.reduce((sum, item) => sum + item.total_shortfall, 0);
    
    container.innerHTML = `
        <div class="col-md-3">
            <div class="card border-0 bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-play-circle fa-2x mb-2"></i>
                    <h3>${totalRuns}</h3>
                    <p class="mb-0">総実行回数</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h3>${avgRuntime.toFixed(1)}秒</h3>
                    <p class="mb-0">平均実行時間</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-warning text-dark">
                <div class="card-body text-center">
                    <i class="fas fa-yen-sign fa-2x mb-2"></i>
                    <h3>¥${Math.round(avgFee).toLocaleString()}</h3>
                    <p class="mb-0">平均手数料</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 ${totalShortfall > 0 ? 'bg-danger text-white' : 'bg-info text-white'}">
                <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <h3>${totalShortfall.toLocaleString()}</h3>
                    <p class="mb-0">残高不足総額</p>
                </div>
            </div>
        </div>
    `;
}

function updateKPICharts() {
    // Runtime chart
    const runtimeCtx = document.getElementById('runtimeChart').getContext('2d');
    if (charts.runtime) charts.runtime.destroy();
    
    charts.runtime = new Chart(runtimeCtx, {
        type: 'line',
        data: {
            labels: kpiData.map(item => new Date(item.timestamp).toLocaleDateString('ja-JP')),
            datasets: [{
                label: '実行時間 (秒)',
                data: kpiData.map(item => item.runtime_sec),
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '実行時間 (秒)'
                    }
                }
            }
        }
    });
    
    // Fee chart
    const feeCtx = document.getElementById('feeChart').getContext('2d');
    if (charts.fee) charts.fee.destroy();
    
    charts.fee = new Chart(feeCtx, {
        type: 'bar',
        data: {
            labels: kpiData.map(item => new Date(item.timestamp).toLocaleDateString('ja-JP')),
            datasets: [{
                label: '手数料 (円)',
                data: kpiData.map(item => item.total_fee),
                backgroundColor: '#28a745',
                borderColor: '#28a745',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '手数料 (円)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '¥' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    
    // Combined chart
    const combinedCtx = document.getElementById('combinedChart').getContext('2d');
    if (charts.combined) charts.combined.destroy();
    
    charts.combined = new Chart(combinedCtx, {
        type: 'line',
        data: {
            labels: kpiData.map(item => new Date(item.timestamp).toLocaleDateString('ja-JP')),
            datasets: [
                {
                    label: '実行時間 (秒)',
                    data: kpiData.map(item => item.runtime_sec),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    yAxisID: 'y'
                },
                {
                    label: '手数料 (円)',
                    data: kpiData.map(item => item.total_fee),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '実行時間 (秒)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '手数料 (円)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        callback: function(value) {
                            return '¥' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function updateKPITable() {
    const tbody = document.getElementById('kpiTableBody');
    
    if (kpiData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                    データがありません
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = kpiData.slice().reverse().map((item, index) => `
        <tr>
            <td>${new Date(item.timestamp).toLocaleString('ja-JP')}</td>
            <td class="text-end">${item.runtime_sec.toFixed(2)}</td>
            <td class="text-end">¥${item.total_fee.toLocaleString()}</td>
            <td class="text-end">${item.total_shortfall > 0 ? 
                `<span class="text-danger">¥${item.total_shortfall.toLocaleString()}</span>` : 
                '<span class="text-success">なし</span>'}</td>
            <td>
                <span class="badge ${item.total_shortfall > 0 ? 'bg-warning' : 'bg-success'}">
                    ${item.total_shortfall > 0 ? '警告' : '正常'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="showKPIDetail(${index})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function updatePerformanceMetrics() {
    const container = document.getElementById('performanceMetrics');
    
    if (kpiData.length === 0) {
        container.innerHTML = '<p class="text-muted">データがありません</p>';
        return;
    }
    
    const runtimes = kpiData.map(item => item.runtime_sec);
    const avgRuntime = runtimes.reduce((a, b) => a + b, 0) / runtimes.length;
    const maxRuntime = Math.max(...runtimes);
    const minRuntime = Math.min(...runtimes);
    
    const performanceScore = maxRuntime < 30 ? 'A' : maxRuntime < 60 ? 'B' : 'C';
    const scoreColor = performanceScore === 'A' ? 'success' : performanceScore === 'B' ? 'warning' : 'danger';
    
    container.innerHTML = `
        <div class="row text-center">
            <div class="col-6">
                <h4 class="text-${scoreColor}">${performanceScore}</h4>
                <small class="text-muted">パフォーマンス</small>
            </div>
            <div class="col-6">
                <h4>${avgRuntime.toFixed(1)}s</h4>
                <small class="text-muted">平均実行時間</small>
            </div>
        </div>
        <hr>
        <div class="small">
            <div class="d-flex justify-content-between">
                <span>最大実行時間:</span>
                <span>${maxRuntime.toFixed(1)}秒</span>
            </div>
            <div class="d-flex justify-content-between">
                <span>最小実行時間:</span>
                <span>${minRuntime.toFixed(1)}秒</span>
            </div>
        </div>
    `;
}

function updateQualityMetrics() {
    const container = document.getElementById('qualityMetrics');
    
    if (kpiData.length === 0) {
        container.innerHTML = '<p class="text-muted">データがありません</p>';
        return;
    }
    
    const successfulRuns = kpiData.filter(item => item.total_shortfall === 0).length;
    const successRate = (successfulRuns / kpiData.length) * 100;
    const qualityGrade = successRate === 100 ? 'A+' : successRate >= 95 ? 'A' : successRate >= 90 ? 'B' : 'C';
    const gradeColor = successRate === 100 ? 'success' : successRate >= 95 ? 'primary' : successRate >= 90 ? 'warning' : 'danger';
    
    container.innerHTML = `
        <div class="row text-center">
            <div class="col-6">
                <h4 class="text-${gradeColor}">${qualityGrade}</h4>
                <small class="text-muted">品質グレード</small>
            </div>
            <div class="col-6">
                <h4>${successRate.toFixed(1)}%</h4>
                <small class="text-muted">成功率</small>
            </div>
        </div>
        <hr>
        <div class="small">
            <div class="d-flex justify-content-between">
                <span>成功実行:</span>
                <span>${successfulRuns} / ${kpiData.length}</span>
            </div>
            <div class="d-flex justify-content-between">
                <span>振込不能:</span>
                <span class="text-success">0件</span>
            </div>
        </div>
    `;
}

function updateAnomalyDetection() {
    const container = document.getElementById('anomalyDetection');
    
    if (kpiData.length === 0) {
        container.innerHTML = '<p class="text-muted">データがありません</p>';
        return;
    }
    
    const runtimes = kpiData.map(item => item.runtime_sec);
    const avgRuntime = runtimes.reduce((a, b) => a + b, 0) / runtimes.length;
    const slowRuns = runtimes.filter(time => time > avgRuntime * 2).length;
    
    const fees = kpiData.map(item => item.total_fee);
    const avgFee = fees.reduce((a, b) => a + b, 0) / fees.length;
    const highFeeRuns = fees.filter(fee => fee > avgFee * 1.5).length;
    
    const anomalies = [];
    if (slowRuns > 0) anomalies.push(`実行時間異常: ${slowRuns}件`);
    if (highFeeRuns > 0) anomalies.push(`高額手数料: ${highFeeRuns}件`);
    
    if (anomalies.length === 0) {
        container.innerHTML = `
            <div class="text-center text-success">
                <i class="fas fa-check-circle fa-3x mb-3"></i>
                <h6>異常なし</h6>
                <p class="small text-muted">全ての実行が正常範囲内です</p>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="text-center text-warning">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h6>検出された異常</h6>
                <ul class="list-unstyled small">
                    ${anomalies.map(anomaly => `<li>• ${anomaly}</li>`).join('')}
                </ul>
            </div>
        `;
    }
}

function showKPIDetail(index) {
    const item = kpiData[kpiData.length - 1 - index];
    alert(`KPI詳細\n\n実行日時: ${new Date(item.timestamp).toLocaleString('ja-JP')}\n実行時間: ${item.runtime_sec.toFixed(2)}秒\n総手数料: ¥${item.total_fee.toLocaleString()}\n残高不足: ${item.total_shortfall > 0 ? '¥' + item.total_shortfall.toLocaleString() : 'なし'}`);
}

function refreshKPI() {
    const selectedPeriod = document.querySelector('input[name="period"]:checked').value;
    loadKPIData(parseInt(selectedPeriod));
}

function exportKPI() {
    if (kpiData.length === 0) {
        alert('エクスポートするデータがありません。');
        return;
    }
    
    alert('KPI エクスポート機能は実装中です。');
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = show ? 'flex' : 'none';
}
</script>
{% endblock %}